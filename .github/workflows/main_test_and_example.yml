name: Unit, packaging and deployment tests
on: [ 'push', 'pull_request' ]


jobs:
  tests_and_example_matrix:
    strategy:
      matrix:
        cppenv: [ {
          os: ubuntu-22.04,
          compiler: "gcc-11",
        }, {
          os: ubuntu-22.04,
          compiler: "gcc-12",
        }, {
          os: ubuntu-22.04,
          compiler: "clang-12",
        }, {
          os: ubuntu-22.04,
          compiler: "clang-13",
        }, {
          os: ubuntu-22.04,
          compiler: "clang-14",
        } ]
      fail-fast: false
    name: ${{ matrix.cppenv.os }}, ${{ matrix.cppenv.compiler }}, ${{ fromJSON('["", ", coverage report"]')[matrix.cppenv.compiler == 'gcc-12' && matrix.shared] }}
    uses: ./.github/workflows/reusable_test_and_example_config.yml
    with:
      os: ${{ matrix.cppenv.os }}
      compiler: ${{ matrix.cppenv.compiler }}
      cmake-version: 3.22.6
      with-coverage: ${{ matrix.cppenv.compiler == 'gcc-12' && matrix.shared }}
    secrets:
      coverall-token: ${{ secrets.COVERALLS_TOKEN }}

  packaging:
    name: Test Packaging and Deployment
    uses: ./.github/workflows/reusable_packaging_and_deployment.yml
    with:
      os: ubuntu-22.04
      compiler: clang-14
      cmake-version: 3.22.6
